<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Proto Animator</title>
  <link rel="shortcut icon" href="data:," />
</head>
<body>
  <main>
    <h1>ProtoESP - Animator</h1>
    <div> <!-- START OF EARS PART -->
      <h2>Ears</h2>
      <hr>
      <label for="typeEars">Animation: </label> <sup onclick="alert('Select custom or prefab ears animation')">&#9432;</sup>
      <select id="typeEars">
        <option value="custom">custom</option>
        <option value="rainbow">rainbow</option>
        <option value="white_noise">white_noise</option>
        <option value="corner_sabers">corner_sabers</option>
        <option value="custom_glow">custom_glow</option>
      </select>
      <div id="earsDiv">
        <div id="divForSvg">
          <svg id="svg1" viewBox="0 0 640 640" width="480" height="480" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <g fill="black">
              <path id="37" d="m350 320a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="36" d="m286.36 256.36a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="35" d="m260 320a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="34" d="m286.36 383.64a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="33" d="m350 410a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="32" d="m413.64 383.64a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="31" d="m440 320a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="30" d="m413.64 256.36a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="29" d="m350 230a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="28" d="m260 164.12a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="27" d="m194.12 230a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="26" d="m170 320a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="25" d="m194.12 410a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="24" d="m260 475.88a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="23" d="m350 500a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="22" d="m440 475.88a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="21" d="m505.88 410a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="20" d="m530 320a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="19" d="m505.88 230a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="18" d="m440 164.12a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="17" d="m350 140a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="16" d="m248.86 69.66a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="15" d="m159.08 129.08a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="14" d="m101.464 214.5a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="13" d="m80 320a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="12" d="m99.66 421.14a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="11" d="m159.08 510.92a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="10" d="m244.5 568.54a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="9" d="m350 590a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="8" d="m451.14 570.34a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="7" d="m540.92 510.92a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="6" d="m598.54 425.5a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="5" d="m620 320a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="4" d="m600.34 218.86a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="3" d="m540.92 129.08a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="2" d="m455.5 71.464a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
              <path id="1" d="m350 50a30 30 0 1 1-1e-5 -0.02" paint-order="stroke fill markers"/>
            </g>
          </svg>
        </div>
        <br>
        <button onclick="fillBlack()">Fill black</button>
        <button onclick="mirrorEars()">Copy left to right</button><br>
        <label for="timespanEars"> Frame timespan</label>
        <input type="number" id="timespanEars" value="500" min="1"> |
        <button onclick="frameGenEars(-1)">Add ears frame</button><br>
        <p class="timespan">Frames:</p>
        <div id="earsFramesP"></div>
        <div id="editDivEars" style="display:none">
          <button id="saveEditFrameEars" value="0">Save frame</button>
          <button onclick="deleteFrameEars()">Delete frame</button>
          <button onclick="cloneEarsFrame()">Clone frame</button>
        </div>
      </div>
    </div> <!-- END OF EARS PART -->
    <hr><hr>
    <div id="usedColorsMain">
      <div class="playBtns">
        <button onclick="playAnim();">Play animation</button>
        <button onclick="stopAnim();">Stop</button> |
        Pick color: 
        <input type="color" id="color" value="#000000"> |
        Used colors:
      </div>
      <div id="usedColors"></div>
    </div>
    <hr><hr>
    <div> <!-- START OF VISOR PART -->
      <h2>Visor</h2>
      <hr>
      <label for="visorConfig">Config: </label> <sup onclick="alert('Select config/wiring of your visor\n\'custom_file\' works only if your visor files are on the ESP!')">&#9432;</sup>
      <select id="visorConfig">
        <option value="none">None</option>
        <option value="M16mk2">M16 mk2</option>
        <option value="M16mk3">M16 mk3</option>
        <option value="BFoxCZ">BFoxCZ</option>
        <option value="custom">custom</option>
        <option value="custom_file">custom_file</option>
      </select> | 
      <label for="typeVisor">Animation: </label> <sup onclick="alert('Select custom or modifier for visor animation')">&#9432;</sup>
      <select id="typeVisor">
        <option value="custom">custom</option>
        <option value="all_rainbow">all_rainbow</option>
      </select><br>
      <div id="customConfig" style="display: none;">
        <label for="visorCfg">Visor cfg: </label>
        <sup onclick="alert('\'t0\'.. means first matrix etc with numbering\n\'blush0\'.. means first blush segment etc with numbering\n\'-\' means nothing in place\n\'_\' means new line\nExample:\nt0;t1;-;-;-;-;t12;t13;_;-;-;-;t6;t7;-;-;-;_;t2;t3;t4;t5;t8;t9;t10;t11')">&#9432;</sup>
        <input type="text" name="visorCfg" id="visorCfg" size=100><br>
        <label for="mouthCfg">Mouth cfg: </label>
        <sup onclick="alert('Array of bools telling if the segment in order is mouth or not\n(For dynamic speaking effect)\nExample:\n[false,false,true,true,true,true,false,false,true,true,true,true,false,false]')">&#9432;</sup>
        <input type="text" name="mouthCfg" id="mouthCfg" size=100><br>
        <button type="button" onclick="loadCustom();">Load config</button>
      </div>
      <br>
      <div id="visorDiv">
        <div id="matrixes"></div>
        <br><br>
        <p>Matrix control:</p>
        <button type="button" onclick='setAction("copy");'>Copy</button> <button type="button" onclick='setAction("paste");'>Paste</button> <sup onclick="alert('Click on Copy or Paste and then click on matrix which you want to affect')">&#9432;</sup><br>
        <button type="button" onclick="fillBlackVisor()">Empty visor</button>
        <button type="button" onclick="mirrorVisor()">Copy left to right</button> <sup onclick="alert('Might not work due to wierd config/wiring')">&#9432;</sup><br>
        <label for="timespanVisor">Timespan: </label>
        <input type="number" id="timespanVisor" value="500" min="1"> |
        <button onclick="frameGenVisor(-1)">Add visor frame</button><br>
        <p class="timespan">Frames:</p>
        <div id="visorFramesP"></div>
        <div id="editDivVisor" style="display:none">
          <button id="saveEditFrameVisor" value="0">Save frame</button>
          <button onclick="deleteFrameVisor()">Delete frame</button>
          <button onclick="cloneEarsVisor()">Clone frame</button>
        </div>
      </div>
    </div> <!-- END OF VISOR PART -->
    <hr><hr>
  </main>
  <footer>
    1. <button onclick="completeGen()">Generate final JSON</button><br>
    <form action="./savefile" method="post" id="footerForm">
      <label for="output">File content / paste here to load:</label><br>
      <textarea rows="7" cols="100" name="content" id="output" required></textarea><br>
      2. Name of animation (without .json): <input type="text" name="file" required id="fileName"><br>
    </form>
  	<hr>
    Load anim:
    <div id="espLoad">
      <select name="file" id="avaibleanims"></select>
      <button type="button" onclick="loadAnim(true)">Load selected anim</button>
      <button type="button" onclick="deleteFile()">Delete selected file</button>
    </div>
    <button type="button" onclick="loadAnim(false)">Load from textarea</button>
    |
    <input type="file" id="localFile">
    <button onclick="loadLocalFile()">Load from local file</button>
    <p style="text-align:center">Coded by <a target=”_blank” href="https://github.com/ncplyn" class="rainbow-text">@NCPlyn</a></p>
  </footer>
</body>
</html>

<style>
  input,option,button {
    margin-bottom: 5px;
  }
  input[type=number] {
    width:80px;
  }
  p {
    margin-block-start: 0.5em;
    margin-block-end: 0.3em;
  }
  #output,form label {
    margin-left: 1%;
  }
  #earsFramesP,#visorFramesP {
    font-weight: bold;
    font-size: 30px;
  }
  #earsFramesP a,#visorFramesP a {
    padding-right: 10px;
  }
  h1,h2 {
    margin-block-start: 0.4em;
    margin-block-end: 0.4em;
    text-align:center;
  }
  body {
    background-color: #333743;
    color: white;
    font-family:Verdana;
  }
  .colorItem {
    width: 40px;
    min-width: 40px;
    max-width: 40px;
    height: 30px;
    min-height: 30px;
    max-height: 30px;
    border: solid 1px gray;
    cursor: pointer;
    float: left;
  }
  #usedColorsMain {
    height: 35px;
  }
  #usedColorsMain button {
    margin-top: 5px;
  }
  .playBtns {
    padding-right:6px;
    float:left;
  }
  path {
    cursor: pointer;
  }
  .leds-matrix {
    background-color: #333;
    border: 1px solid white;
    border-collapse: separate;
    border-spacing: 3px;
  }
  .leds-matrix .item {
    width: 20px;
    min-width: 20px;
    max-width: 20px;
    height: 22px;
    min-height: 22px;
    max-height: 22px;
    cursor: pointer;
    border-radius: 50%;
    box-shadow: inset 0 0 1px #666666;
    background: #808080;
  }
  .leds-matrix .item.active {
    background: #ff0000;
  }
  .leds-matrix .item:hover {
    box-shadow: 0 0 1px #cccccc;
  }
  .blush {
    margin-left: auto;
    margin-right: auto;
  }
  .blush td {
    width: 30px;
    min-width: 30px;
    max-width: 30px;
    height: 32px;
    min-height: 32px;
    max-height: 32px;
  }
  .blush .item {
    cursor: pointer;
    border-radius: 50%;
    box-shadow: inset 0 0 1px #666666;
    background: #000000;
  }
  sup {
    cursor: pointer;
    vertical-align: middle !important;
  }
  .rainbow-text {
    font-weight: bold;
    background-image: repeating-linear-gradient(45deg, violet, indigo, blue, green, yellow, orange, red, violet);
    background-size: 800% 800%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: rainbow 8s ease infinite;
  }
  @keyframes rainbow {
    0% {background-position: 0% 50%}
    50% {background-position: 100% 25%}
    100% {background-position: 0% 50%}
  }
</style>

<script src="jquerymin.js"></script>
<script>

  let visType;
  let visTypeMouth;
  let numOfSegm = 0;
  let numOfBlush = 0;
  
  $("#visorConfig").change(function() {
    numOfSegm = 0;
    numOfBlush = 0;
    visType = "";
    visTypeMouth = "";
    $('#matrixes').empty();
    $("#customConfig").hide();
    if ($("#visorConfig").val() == "BFoxCZ") {
      visType = "t0;t1;-;-;;-;-;t12;t13;_;-;-;-;t6;t7;-;-;-;_;t2;t3;t4;t5;t8;t9;t10;t11";
      visTypeMouth = "[false,false,true,true,true,true,false,false,true,true,true,true,false,false]";
      createHTML(visType);
    } else if ($("#visorConfig").val() == "M16mk2") {
      visType = "t0;t1;-;-;-;t9;t10;_;blush0;blush1;-;t5;-;blush2;blush3;_;t2;t3;t4;-;t6;t7;t8";
      visTypeMouth = "[false,false,true,true,true,false,true,true,true,false,false]";
      createHTML(visType);
    } else if ($("#visorConfig").val() == "M16mk3") {
      visType = "t0;t1;-;-;-;-;-;-;t12;t13;_;blush0;blush1;-;t6;-;-;t7;-;blush2;blush3;_;t2;t3;t4;t5;-;-;t8;t9;t10;t11";
      visTypeMouth = "[false,false,true,true,true,true,false,false,true,true,true,true,false,false]";
      createHTML(visType);
    } else if ($("#visorConfig").val() == "custom_file") {
      loadVisorConfig();
      createHTML(visType);
    } else if ($("#visorConfig").val() == "custom") {
      $("#customConfig").show();
    }
  });
  
  function loadCustom() {
    numOfSegm = 0;
    numOfBlush = 0;
    visType = "";
    visTypeMouth = "";
    $('#matrixes').empty();
    visType = $('#visorCfg').val();
    visTypeMouth = $('#mouthCfg').val();
    createHTML(visType);
  }
  
  //create HTML table by the specified config
  function createHTML(visorType) {
    let arr = visorType.split(";");
    let output = "<table><tr>";
    for(let x = 0; x < arr.length; x++) {
      if(arr[x] == "-") {
        output+= "<td></td>";
      } else if (arr[x] == "_") {
        output+= "</tr><tr>";
      } else if (arr[x].includes("t")) {
        output+= "<td id='"+arr[x]+"'></td>";
        numOfSegm++;
      } else if (arr[x].includes("b")) {
        output+= "<td id='"+arr[x]+"'></td>";
        numOfBlush++;
      }
    }
    output+= "</tr></table>";
    $("#matrixes").append(output);
    
    for (var x = 0; x < numOfSegm; x++) {
      $("#t" + x).append($(generator()));
    }
    //generates tables for blush
    for (var x = 0; x < numOfBlush; x++) {
      if (x < (numOfBlush/2)) { //left blush tilt
        $("#blush" + x).append("<table class=\"blush\"><tr><td class=\"item\" id=\"b" + x*2 + "\"></td><td></td><td></td></tr><tr><td></td></tr><tr><td></td><td></td><td class=\"item\" id=\"b" + ((x*2) + 1) + "\"></td></tr></table>");
      } else { //right blush tilt
        $("#blush" + x).append("<table class=\"blush\"><tr><td></td><td></td><td class=\"item\" id=\"b" + ((x*2) + 1) + "\"></td></tr><tr><td></td></tr><tr><td class=\"item\" id=\"b" + x*2 + "\"></td><td></td><td></td></tr></table>");
      }
    }
  }
  
  //table leds generator
  function generator() {
    var out = ['<table class="leds-matrix">'];
    for (var i = 1; i < 9; i++) {
      out.push('<tr>');
      for (var j = 1; j < 9; j++) {
        out.push('<td class="item" data-row="' + i + '" data-col="' + j + '"></td>');
      }
      out.push('</tr>');
    }
    out.push('</table>');
    return out.join('');
  }

  const rgb2hex = (rgb) => `${rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map(n => parseInt(n, 10).toString(16).padStart(2, '0')).join('')}`
  //clone svg to save on file size
  $('#svg1').clone().appendTo($('#divForSvg'));
  $('#divForSvg svg:nth-child(2)').attr("id", "svg2");

  //cliked on used color and set it
  $("#usedColors").on('click', ".colorItem", function() {
    var temp = "#" + rgb2hex($(this).css("background-color"));
    curColor = temp;
    $("#color").val(temp);
  });

  //on color selected, set to global
  var curColor = "#000000";
  $("#color").change(function() {
    curColor = $(this).val();
    $("#usedColors").append("<div class=\"colorItem\" style=\"background-color:" + curColor + "\"></div>");
  });

  //Hold down to color
  isMouseDown = false;
  $('body').mousedown(function() {
    isMouseDown = true;
  })
  .mouseup(function() {
    isMouseDown = false;
  });

  //colors SVG dots with selected color
  $("path").on('click', function() {
    $(this).attr('fill', curColor);
    $(this).attr('stroke', "gray");
  });
  $("path").mouseenter(function() {
    if(isMouseDown) {
      $(this).attr('fill', curColor);
      $(this).attr('stroke', "gray");
    }
  });
  
  //colors blush dots with selected color
  $("#matrixes").on('click', '.blush .item', function() {
    $(this).css("background-color", curColor);
  });

  //fills all black, what more to say
  function fillBlack() {
    for (var x = 1; x < 38; x++) {
      $("#svg1").find("#" + x).attr('fill', "#000000");
      $("#svg2").find("#" + x).attr('fill', "#000000");
    }
  }
  fillBlack();

  //mirrors left ear to right one
  function mirrorEars() {
    for (var x = 1; x < 38; x++) {
      $("#svg2").find("#" + x).attr('fill', $("#svg1").find("#" + x).attr('fill'));
    }
  }

  //hides animator if not needed
  $("#typeEars").change(function() {
    if ($("#typeEars").val() == "custom" || $("#typeEars").val() == "custom_glow") {
      $("#earsDiv").show();
    } else {
      $("#earsDiv").hide();
    }
  });
  /*$("#typeVisor").change(function() {
    if ($("#typeVisor").val() == "custom") {
      $("#visorDiv").show();
    } else {
      $("#visorDiv").hide();
    }
  });*/

  var nowEditEarsFrame = 0;
  //deletes selected frame
  function deleteFrameEars() {
    if (nowEditEarsFrame > -1) {
      framesEars.splice(nowEditEarsFrame, 1);
    }
    nowEditEarsFrame = 0;
    if (framesEars.length != 0) {
      loadEarsFrame();
    } else {
      fillBlack();
    }
    $("#earsFramesP").html("");
    for (var x = 0; x < framesEars.length; x++) {
      $("#earsFramesP").append("<a id=\"" + x + "\">" + x + "</a>");
    }
    $("#editDivEars").hide();
  }

  //detects click on frame to edit, call function to load it
  $("#earsFramesP").on('click', "a", function() {
    if ($(this).closest('div').attr('id') == "earsFramesP") {
      nowEditEarsFrame = $(this).attr('id');
      loadEarsFrame();
    }
  });

  //loads selected frame from array
  function loadEarsFrame() {
    var obj = JSON.parse(framesEars[nowEditEarsFrame]);
    $("#timespanEars").val(obj.timespan);
    for (var x = 0; x < obj.leds.length; x++) {
      if (x < 37) {
        $("#svg1").find("#" + (x + 1)).attr('fill', "#" + obj.leds[x]);
      } else {
        $("#svg2").find("#" + (x - 36)).attr('fill', "#" + obj.leds[x]);
      }
    }
    $("#editDivEars").show();
    $("#saveEditFrameEars").attr('value', nowEditEarsFrame);
  }

  //calls frame generator to save currently editing frame
  $("#saveEditFrameEars").on('click', function() {
    frameGenEars($(this).attr('value'));
    $("#editDivEars").hide();
  });

  //get json code for ears and visor, generates final usable code and resets stuff
  function completeGen() {
    if ($("#visorConfig").val() == "none" || framesVisor.length == 0 || (framesEars.length == 0 && ( $("#typeEars").val() == "custom"  || $("#typeEars").val() == "custom_glow" ))) {
      alert("No frames in ears or visor!");
    } else {
      var output = "{" + earsGen() + "," + visorGen() + "}";
      output = output.replace(/"000000"/g, "\"0\"");
      $("#output").val(output);
      /*$("#earsFramesP").empty();
      $("#editDivEars").hide();
      $("#visorFramesP").empty();
      $("#editDivVisor").hide();
      fillBlack();
      fillBlackVisor();
      framesEars.length = 0;
      framesVisor.length = 0;*/
    }
  }

  var framesEars = [];
  //function that get the type of animation and creates entire 'ears' object and returns it
  function earsGen() {
    var output = "";
    if ($("#typeEars").val() == "custom" || $("#typeEars").val() == "custom_glow") {
      output += "\"ears\":{\"type\":\""+$("#typeEars").val()+"\",\"frames\":[";
      for (var x = 0; x < framesEars.length; x++) {
        output += framesEars[x];
        if (x !== framesEars.length - 1) {
          output += ",";
        }
      }
      output += "]}"
    } else {
      output += "\"ears\":{\"type\":\"" + $("#typeEars").val() + "\"}";
    }
    return output;
  }

  //function that gets data from timespan input and SVG pictures, creates frames formated in JSON
  //end puts them in array, also can edit those frames by rewriting specific frame
  function frameGenEars(editing) {
    if ($("#timespanEars").val().length == 0 && $("#timespanEars").val() > 0) {
      alert("Timespan missing");
    } else {
      var temp = "{\"timespan\":" + $("#timespanEars").val() + ",\"leds\":[";
      for (var x = 1; x < 38; x++) {
        if (x > 1) {
          temp += ",";
        }
        temp += "\"" + $("#svg1").find("#" + x).attr('fill').substring(1) + "\"";
      }
      for (var x = 1; x < 38; x++) {
        if (x < 38) {
          temp += ",";
        }
        temp += "\"" + $("#svg2").find("#" + x).attr('fill').substring(1) + "\"";
      }
      temp += "]}";
      if (editing < 0) {
        framesEars.push(temp);
        $("#earsFramesP").append("<a id=\"" + (framesEars.length - 1) + "\">" + (framesEars.length - 1) + "</a>");
      } else {
        framesEars[editing] = temp;
      }
    }
  }

  //clone selected fram to the end of array
  function cloneEarsFrame() {
    framesEars.push(framesEars[nowEditEarsFrame]);
    $("#earsFramesP").append("<a id=\"" + (framesEars.length - 1) + "\">" + (framesEars.length - 1) + "</a>");
  }

  var nowEditVisorFrame = 0;

  //deletes selected frame
  function deleteFrameVisor() {
    if (nowEditVisorFrame > -1) {
      framesVisor.splice(nowEditVisorFrame, 1);
    }
    nowEditVisorFrame = 0;
    if (framesVisor.length != 0) {
      loadVisorFrame();
    } else {
      fillBlackVisor();
    }
    $("#visorFramesP").html("");
    for (var x = 0; x < framesVisor.length; x++) {
      $("#visorFramesP").append("<a id=\"" + x + "\">" + x + "</a>");
    }
    $("#editDivVisor").hide();
  }

  //detects click on frame to edit, call function to load it
  $("#visorFramesP").on('click', "a", function() {
    if ($(this).closest('div').attr('id') == "visorFramesP") {
      nowEditVisorFrame = $(this).attr('id');
      loadVisorFrame();
    }
  });

  //loads selected frame from array
  function loadVisorFrame() {
    var obj = JSON.parse(framesVisor[nowEditVisorFrame]);
    $("#timespanVisor").val(obj.timespan);
    for (var x = 0; x < obj.leds.length; x++) {
      hexInputToLeds(x, obj.leds[x])
    }
    for (var x = 0; x < numOfBlush*2; x++) {
      $("#b" + x).css("background-color", obj.ledsBlush[x]);
    }
    $("#editDivVisor").show();
    $("#saveEditFrameVisor").attr('value', nowEditVisorFrame);
  }

  //fixes hex pattern
  function fixPattern(pattern) {
    pattern = pattern.replace(/[^0-9a-fA-F]/g, '0');
    return ('0000000000000000' + pattern).substr(-16);
  }

  //loads leds from hex
  function hexInputToLeds(segment, value) {
    var val = fixPattern(value);
    for (var i = 1; i < 9; i++) {
      var byte = val.substr(-2 * i, 2);

      byte = parseInt(byte, 16);
      for (var j = 1; j < 9; j++) {
        var active = !!(byte & 1 << (j - 1));
        $('#t' + segment).find('.item[data-row=' + i + '][data-col=' + j + '] ').toggleClass('active', active);
      }
    }
  }

  //calls frame generator to save currently editing frame
  $("#saveEditFrameVisor").on('click', function() {
    frameGenVisor($(this).attr('value'));
    $("#editDivVisor").hide();
  });

  function fillBlackVisor() {
    for (var x = 0; x < numOfSegm; x++) {
      hexInputToLeds(x, "0000000000000000");
    }
    for (var x = 0; x < numOfBlush*2; x++) {
      $("#b" + x).css("background-color", "#000000");
    }
  }
  fillBlackVisor();

  //if matrix led clicked, add class
  $("#matrixes").on('click', '.item', function() {
    if(matrixAction == "")
      $(this).toggleClass('active');
  });
  $("#matrixes").on('mouseenter', '.item', function() {
    if(matrixAction == "" && isMouseDown)
      $(this).toggleClass('active');
  });

  //return hex of segment
  function ledsToHex(segment) {
    var out = [];
    for (var i = 1; i < 9; i++) {
      var byte = [];
      for (var j = 1; j < 9; j++) {
        var active = $('#t' + segment).find('.item[data-row=' + i + '][data-col=' + j + '] ').hasClass('active');
        byte.push(active ? '1' : '0');
      }
      byte.reverse();
      byte = parseInt(byte.join(''), 2).toString(16);
      byte = ('0' + byte).substr(-2);
      out.push(byte);
    }
    out.reverse();
    return out.join('');
  }

  //mirrors left half to right one --will work if both sides are wired the same
  function mirrorVisor() {
    for (let i = 1; i < 9; i++) {
      for (let j = 1; j < 9; j++) {
        let numFix = numOfSegm-1;
        for (let l = 0; l < numFix/2; l++) {
          if(numOfSegm % 2 == 1 && numFix == (numOfSegm/2)+1) {l++;}
          $('#t' + (numFix-l)).find('.item[data-row=' + i + '][data-col=' + j + '] ').attr("class", $('#t' + l).find('.item[data-row=' + i + '][data-col=' + (9-j) + '] ').attr("class"));
        }
      }
    }
    let numFix = numOfBlush*2;
    for(let i = 0; i < numFix; i++) {
      $("#matrixes").find("#b"+(numFix-i-1)).css("background-color", $("#matrixes").find("#b"+i).css("background-color"));
    }
  }
  
  function setAction(val) {
    matrixAction = val;
  }
  
  let matrixAction = "";
  $("#matrixes").on('click', 'table', function(e) {
    let tID = $(this).closest('td[id]').attr('id');
    if(tID !== undefined && tID.includes("t")) {
      if(matrixAction == "paste") {
        for (var i = 1; i < 9; i++) {
          for (var j = 1; j < 9; j++) {
            $("#"+tID).find('.item[data-row=' + i + '][data-col=' + j + '] ').attr("class", $("#"+selMatrix).find('.item[data-row=' + i + '][data-col=' + j + '] ').attr("class"));
          }
        }
      } else if (matrixAction == "copy") {
        selMatrix = tID;
      }
      matrixAction = "";
    }
  });

  var framesVisor = [];

  function visorGen() {
    var output = "";
    output += '"visor":{"type":"' + $("#typeVisor").val() + '","isMouth":'+visTypeMouth+',"frames":[';
    for (var x = 0; x < framesVisor.length; x++) {
      output += framesVisor[x];
      if (x !== framesVisor.length - 1) {
        output += ",";
      }
    }
    output += "]}";
    $('#tempP').text(output);
    return output;
  }

  function frameGenVisor(editing) {
    if ($("#timespanVisor").val().length == 0 && $("#timespanVisor").val() > 0) {
      alert("Timespan missing");
    } else {
      var temp = "{\"timespan\":" + $("#timespanVisor").val() + ",\"leds\":[";
      for (var x = 0; x < numOfSegm; x++) {
        temp += "\"" + ledsToHex(x) + "\"";
        if (x != numOfSegm-1) {
          temp += ",";
        }
      }
      temp += "],\"ledsBlush\":["; //TBD
      for (var x = 0; x < numOfBlush*2; x++) {
        temp += "\"" + rgb2hex($("#b" + x).css("background-color")) + "\"";
        if (x != (numOfBlush*2)-1) {
          temp += ",";
        }
      }
      temp += "]}";
      if (editing < 0) {
        framesVisor.push(temp);
        $("#visorFramesP").append("<a id=\"" + (framesVisor.length - 1) + "\">" + (framesVisor.length - 1) + "</a>");
      } else {
        framesVisor[editing] = temp;
      }
    }
  }

  //clone selected frame to the end of array
  function cloneEarsVisor() {
    framesVisor.push(framesVisor[nowEditVisorFrame]);
    $("#visorFramesP").append("<a id=\"" + (framesVisor.length - 1) + "\">" + (framesVisor.length - 1) + "</a>");
  }
  
  //check for custom and start loops
  function playAnim(){
    if($("#typeEars").val() == "custom") {
      earLoop();
    }
    if($("#typeVisor").val() == "custom") {
      visorLoop();
    }
  }

  //visor and ear loop to show frames
  let visorTimeout,earTimeout;
  function visorLoop() {
    loadVisorFrame();
    if(nowEditVisorFrame == framesVisor.length-1) {
      nowEditVisorFrame = 0;
    } else {
      nowEditVisorFrame++;
    }
    visorTimeout = setTimeout(visorLoop,$("#timespanVisor").val());
  }

  function earLoop() {
    loadEarsFrame();
    if(nowEditEarsFrame == framesEars.length-1) {
      nowEditEarsFrame = 0;
    } else {
      nowEditEarsFrame++;
    }
    earTimeout = setTimeout(earLoop,$("#timespanEars").val());
  }

  //clear timeouts to stop loop
  function stopAnim(){
    clearTimeout(visorTimeout);
    clearTimeout(earTimeout);
  }

  //sends animation to ESP for test
  function postAnim() {
    $.ajax({
      url: '/change',
      type: 'post',
      data: {
        anim: $("#output").val()
      }
    });
  }

  //loads visor type files
  function loadVisorConfig(part) {
    $.ajax({
      type: "GET",
      url: "/visType.txt",
      async: false,
      success: function(response){
        visType = response;
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        alert("Couldn't load /visType.txt");
      }
    });
    $.ajax({
      type: "GET",
      url: "/visTypeMouth.txt",
      async: false,
      success: function(response){
        visTypeMouth = response;
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        alert("Couldn't load /visTypeMouth.txt");
      }
    });
  }

  //loads all available animations
  function loadFiles() {
    $.ajax({
      type: "GET",
      url: "/getfiles",
      async: false,
      success: function(response){
        var partsArray = response.split(';');
        partsArray.pop();
        var arrayLength = partsArray.length;
        for (var i = 1; i < arrayLength; i++) {
          var x = document.getElementById("avaibleanims");
          var option = document.createElement("option");
          option.innerHTML = partsArray[i];
          option.value = partsArray[i];
          document.getElementById("avaibleanims").options.add(option);
        }
        $("#footerForm").append('<p>3. <button type="button" onclick="postAnim()">Try animation</button></p>4. <input type="submit" value="Save to SPIFFS"/>');
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        $("#footerForm").append('3. <button type="button" onclick="saveToFile();">Save to PC</button>');
        $("#espLoad").hide();
      }
    });
  }
  loadFiles();
  
  function loadLocalFile() {
    let fileToLoad = document.getElementById("localFile").files[0];
    if(fileToLoad === undefined || fileToLoad.name.includes(".json") == false) {
      alert("No selected file or not a .json file!");
    } else {
      let fileReader = new FileReader();
      fileReader.onload = function (fileLoadedEvent) {
          $("#output").val(fileLoadedEvent.target.result);
          loadAnim();
      };
      fileReader.readAsText(fileToLoad, "UTF-8");
    }
  }
  
  function saveToFile() {
    var link = document.createElement('a');
    link.href = 'data:text/plain;charset=UTF-8,' + escape($("#output").val());
    link.download = $("#fileName").val()+".json";
    link.click();
  }
  
  function deleteFile() {
    if(confirm("Delete selected animation?")) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/deletefile?file="+$("#avaibleanims").val(), true);
      xhr.send(null);
	  }
	}

  //loads animation from textarea or from file
  function loadAnim(loadFrom) {
    fillBlack();
    fillBlackVisor();
    var response;
    if (loadFrom) {
      response = $.ajax({
        type: "GET",
        url: "/anims/"+$("#avaibleanims").val(),
        async: false
      }).responseText;
    } else {
      response = $("#output").val();
    }
    var obj = JSON.parse(response);
    if (obj.ears.type == "custom" || obj.ears.type == "custom_glow") {
      framesEars.length = 0;
      $("#visorEarsP").html("");
      $("#earsDiv").show();
      $('#typeEars option[value="'+obj.ears.type+'"]').prop('selected', true);
      for (var x = 0; x < obj.ears.frames.length; x++) {
        framesEars.push(JSON.stringify(obj.ears.frames[x]));
        $("#earsFramesP").append("<a id=\"" + (framesEars.length - 1) + "\">" + (framesEars.length - 1) + "</a>");
      }
    } else {
      $('#typeEars option[value="'+obj.ears.type+'"]').prop('selected', true);
      $("#earsDiv").hide();
    }
    framesVisor.length = 0;
    $("#visorFramesP").html("");
    $('#typeVisor option[value="'+obj.visor.type+'"]').prop('selected', true);
    for (var x = 0; x < obj.visor.frames.length; x++) {
      framesVisor.push(JSON.stringify(obj.visor.frames[x]));
      $("#visorFramesP").append("<a id=\"" + (framesVisor.length - 1) + "\">" + (framesVisor.length - 1) + "</a>");
    }
    alert("Loaded animation");
  }
</script>
